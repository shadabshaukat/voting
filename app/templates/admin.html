<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('SW registration failed:', err));
        }
    </script>
    <!-- Chart.js for results visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="container" id="admin-container">
    <h1>Admin Dashboard</h1>

    <section id="login-section">
        <h2>Login</h2>
        <form id="login-form">
            <label>Username</label>
            <input type="text" name="username" required>
            <label>Password</label>
            <input type="password" name="password" required>
            <button type="submit">Login</button>
        </form>
    </section>

    <section id="dashboard-section" style="display:none;">
        <h2>Create New Poll</h2>
        <form id="create-poll-form" style="border:1px solid #ddd;padding:1rem;border-radius:8px;">
            <fieldset style="margin-bottom:1rem;">
                <legend>Poll Details</legend>
                <label>Title</label>
                <input type="text" name="title" required>

                <label>Description</label>
                <textarea name="description"></textarea>

                <div style="display:flex;gap:1rem;flex-wrap:wrap;">
                    <div style="flex:1;min-width:220px;">
                        <label>Start Time</label>
                        <input type="datetime-local" name="start_time" required>
                    </div>
                    <div style="flex:1;min-width:220px;">
                        <label>End Time</label>
                        <input type="datetime-local" name="end_time" required>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Questions</legend>
                <div id="questions-container"></div>
                <button type="button" id="add-question-btn">+ Add Question</button>
            </fieldset>

            <div style="margin-top:1rem;display:flex;justify-content:flex-end;gap:0.5rem;">
                <button type="submit">Create Poll</button>
            </div>
        </form>

        <script>
        // Dynamic question/choice builder (clean layout with is_correct checkbox)
        let questionCount = 0;

        function createChoiceInput(qIdx) {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-block';
            choiceDiv.style.display = 'flex';
            choiceDiv.style.gap = '0.5rem';
            choiceDiv.style.alignItems = 'center';
            choiceDiv.innerHTML = `
                <input type="text" name="choice-${qIdx}" placeholder="Choice text" required style="flex:1;">
                <label style="display:flex;align-items:center;gap:0.25rem;">
                    <input type="checkbox" name="is_correct-${qIdx}"> Correct
                </label>
                <button type="button" class="remove-choice-btn">Remove</button>
            `;
            choiceDiv.querySelector('.remove-choice-btn').onclick = () => choiceDiv.remove();
            return choiceDiv;
        }

        function createQuestionBlock() {
            const qIdx = questionCount++;
            const qDiv = document.createElement('div');
            qDiv.className = 'question-block';
            qDiv.style.border = '1px dashed #ccc';
            qDiv.style.padding = '0.75rem';
            qDiv.style.marginBottom = '0.75rem';
            qDiv.innerHTML = `
                <label>Question</label>
                <input type="text" name="question-${qIdx}" placeholder="Type the question..." required>
                <div class="choices-container" id="choices-${qIdx}" style="margin-top:0.5rem;"></div>
                <div style="margin-top:0.5rem;display:flex;gap:0.5rem;">
                    <button type="button" class="add-choice-btn">+ Add Choice</button>
                    <button type="button" class="remove-question-btn">Remove Question</button>
                </div>
            `;

            qDiv.querySelector('.add-choice-btn').onclick = () => {
                const choicesDiv = qDiv.querySelector(`#choices-${qIdx}`);
                choicesDiv.appendChild(createChoiceInput(qIdx));
            };
            qDiv.querySelector('.remove-question-btn').onclick = () => qDiv.remove();

            // Two initial choices
            const choicesDiv = qDiv.querySelector(`#choices-${qIdx}`);
            choicesDiv.appendChild(createChoiceInput(qIdx));
            choicesDiv.appendChild(createChoiceInput(qIdx));

            return qDiv;
        }

        document.getElementById('add-question-btn').onclick = () => {
            const container = document.getElementById('questions-container');
            container.appendChild(createQuestionBlock());
        };
        </script>

        <h2>Existing Polls</h2>
        <div id="poll-list"></div>

        <!-- Results & Winners Panel (simple by default) -->
        <section id="results-section" style="display:none;margin-top:1rem;border-top:1px solid #ddd;padding-top:1rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
                <h2 style="margin:0;">Results: <span id="results-title"></span></h2>
                <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                    <label style="display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" id="toggle-details"> Show details
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" id="toggle-correct"> Show correct answers
                    </label>
                    <button id="close-results" type="button">Close</button>
                </div>
            </div>

            <!-- Simple winner display -->
            <div id="winner-main" style="margin-top:0.5rem;padding:0.5rem 0;font-weight:600;color:#2e7d32;"></div>

            <!-- Charts (hidden by default until details enabled) -->
            <div id="results-charts" style="display:none;margin-top:0.75rem;gap:1rem;"></div>

            <div id="winners-panel" style="margin-top:1rem;border:1px solid #eee;padding:0.75rem;border-radius:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0;">Winners</h3>
                    <div style="display:flex;gap:0.5rem;">
                        <button id="refresh-winners" type="button">Refresh</button>
                        <button id="pick-winner" type="button">Pick Random Winner</button>
                    </div>
                </div>
                <div id="picked-winner" style="margin-top:0.5rem;color:#2e7d32;font-weight:600;"></div>
                <ul id="winners-list" style="margin-top:0.5rem;display:none;"></ul>
            </div>

            <div id="nonwinners-panel" style="display:none;margin-top:1rem;border:1px solid #eee;padding:0.75rem;border-radius:6px;">
                <h3 style="margin:0;">Participants who didnt answer all correctly</h3>
                <ul id="nonwinners-list" style="margin-top:0.5rem;"></ul>
            </div>
        </section>
    </section>
</div>

<script>
let token = null;
let currentPollId = null;
let charts = []; // { chart: Chart, isCorrects: boolean[] }

// Helper
async function api(path, opts = {}) {
    const headers = opts.headers ? { ...opts.headers } : {};
    if (token) headers['Authorization'] = `Bearer ${token}`;
    if (!headers['Content-Type'] && opts.body && typeof opts.body === 'string') {
        headers['Content-Type'] = 'application/json';
    }
    const resp = await fetch(path, { ...opts, headers });
    if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(`Error ${resp.status}: ${txt}`);
    }
    return await resp.json();
}

// Login
document.getElementById('login-form').onsubmit = async (e) => {
    e.preventDefault();
    const f = e.target;
    try {
        const payload = { username: f.username.value, password: f.password.value };
        const res = await api('/admin/login', {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'application/json' }
        });
        token = res.access_token;
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'block';
        loadPolls();
    } catch (err) {
        alert('Login failed: ' + err.message);
    }
};

// Create poll
document.getElementById('create-poll-form').onsubmit = async (e) => {
    e.preventDefault();
    const f = e.target;

    // Gather questions and choices from dynamic UI
    const questions = [];
    const qBlocks = document.querySelectorAll('.question-block');
    qBlocks.forEach(qb => {
        const qText = qb.querySelector(`input[name^="question-"]`).value.trim();
        if (!qText) return; // skip empty
        const choices = [];
        const choiceBlocks = qb.querySelectorAll('.choice-block');
        choiceBlocks.forEach(block => {
            const textInput = block.querySelector('input[type="text"]');
            const checkInput = block.querySelector('input[type="checkbox"]');
            const cText = (textInput?.value || '').trim();
            const isCorrect = !!(checkInput && checkInput.checked);
            if (cText) choices.push({ text: cText, is_correct: isCorrect });
        });
        if (choices.length === 0) return; // need at least one choice
        questions.push({ text: qText, choices });
    });

    const payload = {
        title: f.title.value,
        description: f.description.value,
        start_time: f.start_time.value ? new Date(f.start_time.value).toISOString() : null,
        end_time: f.end_time.value ? new Date(f.end_time.value).toISOString() : null,
        questions
    };
    try {
        await api('/admin/polls', { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
        alert('Poll created');
        f.reset();
        document.getElementById('questions-container').innerHTML = '';
        questionCount = 0;
        loadPolls();
    } catch (err) {
        alert('Failed to create poll: ' + err.message);
    }
};

// Load polls
async function loadPolls() {
    const listDiv = document.getElementById('poll-list');
    listDiv.innerHTML = 'Loading...';
    try {
        const polls = await api('/admin/polls');
        if (!polls || polls.length === 0) {
            listDiv.innerHTML = '<p>No existing Poll</p>';
            return;
        }
        listDiv.innerHTML = '';
        polls.forEach(p => {
            const div = document.createElement('div');
            div.style.border = '1px solid #ccc';
            div.style.padding = '0.5rem';
            div.style.marginBottom = '0.5rem';
            div.innerHTML = `
                <strong>${p.title}</strong> (ID: ${p.id})<br>
                Active: ${p.is_active}<br>
                <button data-id="${p.id}" class="activate-btn">Activate</button>
                <button data-id="${p.id}" class="deactivate-btn">Deactivate</button>
                <button data-id="${p.id}" class="results-btn">View Results</button>
                <pre style="max-height:150px;overflow:auto;">${JSON.stringify(p, null, 2)}</pre>
            `;
            listDiv.appendChild(div);
        });

        document.querySelectorAll('.activate-btn').forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;
                await api(`/admin/polls/${id}/activate`, { method: 'POST' });
                loadPolls();
            };
        });
        document.querySelectorAll('.deactivate-btn').forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;
                await api(`/admin/polls/${id}/deactivate`, { method: 'POST' });
                loadPolls();
            };
        });
        document.querySelectorAll('.results-btn').forEach(btn => {
            btn.onclick = async () => {
                const id = parseInt(btn.dataset.id, 10);
                await openResults(id);
            };
        });
    } catch (err) {
        listDiv.innerHTML = `<p>Error loading polls: ${err.message}</p>`;
    }
}

function computeColors(isCorrects, highlight) {
    const defaultBg = 'rgba(54, 162, 235, 0.7)';
    const defaultBorder = 'rgba(54, 162, 235, 1)';
    const correctBg = 'rgba(75, 192, 75, 0.85)';
    const correctBorder = 'rgba(46, 125, 50, 1)';
    const wrongBg = 'rgba(200, 200, 200, 0.6)';
    const wrongBorder = 'rgba(136, 136, 136, 1)';
    if (!highlight) {
        return {
            bg: isCorrects.map(() => defaultBg),
            border: isCorrects.map(() => defaultBorder)
        };
    }
    return {
        bg: isCorrects.map(x => x ? correctBg : wrongBg),
        border: isCorrects.map(x => x ? correctBorder : wrongBorder)
    };
}

function destroyCharts() {
    charts.forEach(entry => entry.chart.destroy());
    charts = [];
}

async function openResults(pollId) {
    currentPollId = pollId;
    const res = await api(`/admin/polls/${pollId}/results`);
    document.getElementById('results-title').textContent = res.title || `Poll ${pollId}`;

    // Build charts (hidden by default until details enabled)
    destroyCharts();
    const chartsContainer = document.getElementById('results-charts');
    chartsContainer.innerHTML = '';

    res.results.forEach((q, idx) => {
        const card = document.createElement('div');
        card.style.border = '1px solid #eee';
        card.style.padding = '0.75rem';
        card.style.borderRadius = '6px';
        card.innerHTML = `<div style="margin-bottom:0.5rem;"><strong>Q${idx + 1}:</strong> ${q.question_text}</div>`;
        const canvas = document.createElement('canvas');
        canvas.height = 160;
        card.appendChild(canvas);
        chartsContainer.appendChild(card);

        const labels = q.choices.map(c => c.choice_text);
        const data = q.choices.map(c => c.votes);
        const isCorrects = q.choices.map(c => !!c.is_correct);
        const colors = computeColors(isCorrects, document.getElementById('toggle-correct').checked);

        const chart = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: '# of Votes',
                    data,
                    backgroundColor: colors.bg,
                    borderColor: colors.border,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                }
            }
        });
        charts.push({ chart, isCorrects });
    });

    document.getElementById('results-section').style.display = 'block';

    await loadWinners();

    // Respect details toggle on initial open
    const details = document.getElementById('toggle-details').checked;
    chartsContainer.style.display = details ? 'grid' : 'none';
    document.getElementById('winners-list').style.display = details ? 'block' : 'none';
    document.getElementById('nonwinners-panel').style.display = details ? 'block' : 'none';
}

function updateChartColors() {
    const highlight = document.getElementById('toggle-correct').checked;
    charts.forEach(({ chart, isCorrects }) => {
        const colors = computeColors(isCorrects, highlight);
        chart.data.datasets[0].backgroundColor = colors.bg;
        chart.data.datasets[0].borderColor = colors.border;
        chart.update();
    });
}

document.getElementById('toggle-correct').addEventListener('change', updateChartColors);

document.getElementById('toggle-details').addEventListener('change', () => {
    const chartsContainer = document.getElementById('results-charts');
    const show = document.getElementById('toggle-details').checked;
    chartsContainer.style.display = show ? 'grid' : 'none';
    document.getElementById('winners-list').style.display = show ? 'block' : 'none';
    document.getElementById('nonwinners-panel').style.display = show ? 'block' : 'none';
});

document.getElementById('close-results').addEventListener('click', () => {
    destroyCharts();
    document.getElementById('results-section').style.display = 'none';
});

async function loadWinners() {
    const listEl = document.getElementById('winners-list');
    const pickedEl = document.getElementById('picked-winner');
    const winnerMain = document.getElementById('winner-main');
    const nonList = document.getElementById('nonwinners-list');
    pickedEl.textContent = '';
    winnerMain.textContent = '';
    listEl.innerHTML = 'Loading...';
    nonList.innerHTML = '';
    try {
        const res = await api(`/admin/polls/${currentPollId}/winners`);
        const winners = res.winners || [];
        const participants = res.participants || [];
        const total = res.total_questions || 0;

        // Populate winners simple view
        if (winners.length > 0) {
            const first = winners[0];
            winnerMain.textContent = `Winner: ${first.name || 'Anonymous'}${first.company ? ' (' + first.company + ')' : ''}`;
        } else {
            winnerMain.textContent = 'Winner: (none yet)';
        }

        // Detailed lists (shown when details enabled)
        listEl.innerHTML = '';
        winners.forEach(w => {
            const li = document.createElement('li');
            li.textContent = `${w.name || 'Anonymous'}${w.company ? ' (' + w.company + ')' : ''}`;
            listEl.appendChild(li);
        });
        if (winners.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'No winners yet (no participant answered all questions correctly).';
            listEl.appendChild(li);
        }

        // Non-winners summary
        const nonwinners = participants.filter(p => !(p.is_winner));
        if (nonwinners.length > 0) {
            nonwinners.forEach(n => {
                const li = document.createElement('li');
                li.textContent = `${n.name || 'Anonymous'}${n.company ? ' (' + n.company + ')' : ''}  ${n.correct_count}/${n.total_questions} correct`;
                nonList.appendChild(li);
            });
        } else {
            nonList.innerHTML = '<li>Everyone answered all questions correctly.</li>';
        }
    } catch (err) {
        listEl.innerHTML = `<li>Error: ${err.message}</li>`;
    }
}

document.getElementById('refresh-winners').addEventListener('click', loadWinners);

document.getElementById('pick-winner').addEventListener('click', async () => {
    const pickedEl = document.getElementById('picked-winner');
    const winnerMain = document.getElementById('winner-main');
    pickedEl.textContent = '';
    try {
        const res = await api(`/admin/polls/${currentPollId}/pick-winner`, { method: 'POST' });
        const w = res.winner;
        const label = `${w.name || 'Anonymous'}${w.company ? ' (' + w.company + ')' : ''}`;
        pickedEl.textContent = `Selected: ${label}`;
        winnerMain.textContent = `Winner: ${label}`;
        await loadWinners();
    } catch (err) {
        pickedEl.textContent = `No winner selected: ${err.message}`;
    }
});
</script>
</body>
</html>