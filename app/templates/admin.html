<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0069d9">
    <meta name="application-name" content="Voting & Trivia App">
    <meta name="description" content="Create and manage live surveys, polls and trivia. Works offline and installable.">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('SW registration failed:', err));
        }
    </script>
    <!-- Chart.js for results visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Minimal PWA install handler for admin page
        let __adminDeferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            __adminDeferredPrompt = e;
            const btn = document.getElementById('install-btn-admin');
            if (btn) btn.style.display = 'inline-block';
        });
        window.addEventListener('appinstalled', () => {
            __adminDeferredPrompt = null;
            const btn = document.getElementById('install-btn-admin');
            if (btn) btn.style.display = 'none';
        });
        function triggerAdminInstall(){
            if (!__adminDeferredPrompt) return;
            __adminDeferredPrompt.prompt();
            __adminDeferredPrompt.userChoice.finally(() => { __adminDeferredPrompt = null; const btn = document.getElementById('install-btn-admin'); if (btn) btn.style.display = 'none'; });
        }
    </script>
</head>
<body>
<div class="container" id="admin-container">
    <div style="position:absolute;top:10px;right:12px;display:flex;gap:8px;align-items:center;">
        <button id="install-btn-admin" type="button" onclick="triggerAdminInstall()" style="display:none;background:#2e7d32;">Install App</button>
    </div>
    <h1>Admin Dashboard</h1>

    <section id="login-section">
        <h2>Login</h2>
        <form id="login-form">
            <label>Username</label>
            <input type="text" name="username" required>
            <label>Password</label>
            <input type="password" name="password" required>
            <button type="submit">Login</button>
        </form>
    </section>

    <section id="dashboard-section" style="display:none;">
        <div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem;">
            <button id="logout-btn" type="button">Logout</button>
        </div>
        <h2>Create New Event</h2>
        <form id="create-poll-form" style="border:1px solid #ddd;padding:1rem;border-radius:8px;">
            <fieldset style="margin-bottom:1rem;">
                <legend>Event Details</legend>
                <label>Title</label>
                <input type="text" name="title" required>

                <label>Description</label>
                <textarea name="description"></textarea>

                <div style="display:flex;gap:1rem;flex-wrap:wrap;">
                    <div style="flex:1;min-width:220px;">
                        <label>Type</label>
                        <select id="poll_type" name="poll_type">
                            <option value="trivia" selected>Trivia (has correct answers)</option>
                            <option value="survey">Survey (no correct answers)</option>
                            <option value="poll">Poll (no correct answers)</option>
                        </select>
                    </div>
                    <div style="flex:1;min-width:220px;">
                        <label>Start Time</label>
                        <input type="datetime-local" name="start_time" required>
                    </div>
                    <div style="flex:1;min-width:220px;">
                        <label>End Time</label>
                        <input type="datetime-local" name="end_time" required>
                    </div>
                </div>

                <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:0.5rem;">
                    <div style="flex:1;min-width:220px;">
                        <label>Session duration (minutes)</label>
                        <input type="number" id="session_minutes" min="1" placeholder="e.g., 30">
                    </div>
                    <div style="flex:1;min-width:220px;">
                        <label>Join Code (optional)</label>
                        <input type="text" name="slug" id="slug" placeholder="e.g., a1b2c">
                        <label style="display:flex;align-items:center;gap:0.5rem;margin-top:0.25rem;">
                            <input type="checkbox" id="generate_url"> Generate Join Code
                        </label>
                        <div id="slug_preview" style="font-size:0.9rem;color:#555;margin-top:0.25rem;display:none;"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Templates</legend>
                <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
                    <select id="template-select">
                        <option value="">-- Choose a template (optional) --</option>
                        <option value="seminar_survey">Seminar Feedback (Survey)</option>
                        <option value="feature_poll">Feature Vote (Poll)</option>
                        <option value="pg_trivia">PostgreSQL Trivia (Trivia)</option>
                        <option value="ai_world_tour_pg">AI World Tour PostgreSQL Trivia</option>
                    </select>
                    <button type="button" id="apply-template">Apply Template</button>
                </div>
            </fieldset>

            <fieldset>
                <legend>Questions</legend>
                <div id="questions-container"></div>
                <button type="button" id="add-question-btn">+ Add Question</button>
            </fieldset>

            <div style="margin-top:1rem;display:flex;justify-content:flex-end;gap:0.5rem;">
                <button type="submit">Create Event</button>
            </div>
        </form>

        <script>
        // Dynamic question/choice builder (clean layout with is_correct checkbox)
        let questionCount = 0;

        const TEMPLATES = {
            seminar_survey: {
                poll_type: 'survey',
                title: 'Seminar Feedback',
                description: 'Help us improve by sharing your feedback.',
                questions: [
                    { text: 'Overall satisfaction with the session', choices: ['Strongly Agree','Agree','Neutral','Disagree','Strongly Disagree'] },
                    { text: 'Content relevance to your role', choices: ['Strongly Agree','Agree','Neutral','Disagree','Strongly Disagree'] },
                    { text: 'Speaker effectiveness', choices: ['Strongly Agree','Agree','Neutral','Disagree','Strongly Disagree'] },
                    { text: 'Likelihood to recommend this session', choices: ['Very Likely','Likely','Neutral','Unlikely','Very unlikely'] },
                ]
            },
            feature_poll: {
                poll_type: 'poll',
                title: 'Feature Prioritization',
                description: 'Vote for the next feature to prioritize.',
                questions: [
                    { text: 'Which Postgres feature should we prioritize next?', choices: ['Performance','Replication','AI','Analytics'] }
                ]
            },
            pg_trivia: {
                poll_type: 'trivia',
                title: 'PostgreSQL Trivia',
                description: 'Test your PostgreSQL knowledge!',
                questions: [
                    { text: 'Which command creates an index in PostgreSQL?', choices: [
                        { text: 'CREATE INDEX ...', is_correct: true },
                        { text: 'MAKE INDEX ...', is_correct: false },
                        { text: 'NEW INDEX ...', is_correct: false }
                    ]},
                    { text: 'Which data type stores JSON in PostgreSQL?', choices: [
                        { text: 'JSONB', is_correct: true },
                        { text: 'TEXTARRAY', is_correct: false },
                        { text: 'BLOB', is_correct: false }
                    ]},
                    { text: 'Which feature supports horizontal scaling across nodes?', choices: [
                        { text: 'Foreign Data Wrapper (FDW)', is_correct: true },
                        { text: 'VACUUM FULL', is_correct: false },
                        { text: 'CHECKPOINT', is_correct: false }
                    ]}
                ]
            },
            ai_world_tour_pg: {
                poll_type: 'trivia',
                title: 'AI World Tour PostgreSQL Trivia',
                description: 'Test your Postgres Knowledge and win a surprise gift @OracleAIWorldTour',
                slug: 'oracle2026',
                questions: [
                    {
                        text: 'Which configuration parameter most directly impacts the efficiency of complex queries involving large sorts or hash joins?',
                        choices: [
                            { text: 'shared_buffers', is_correct: false },
                            { text: 'work_mem', is_correct: true },
                            { text: 'effective_cache_size', is_correct: false },
                            { text: 'maintenance_work_mem', is_correct: false }
                        ]
                    },
                    {
                        text: 'Which index type is most commonly recommended for approximate nearest-neighbor searches using pgvector on large datasets?',
                        choices: [
                            { text: 'B-tree', is_correct: false },
                            { text: 'Hash', is_correct: false },
                            { text: 'IVFFLAT', is_correct: true },
                            { text: 'BRIN', is_correct: false }
                        ]
                    },
                    {
                        text: 'When using an IVFFLAT index, which action is required to get optimal query performance?',
                        choices: [
                            { text: 'Run VACUUM FULL after index creation', is_correct: false },
                            { text: 'Increase shared_buffers', is_correct: false },
                            { text: 'Set an appropriate number of lists during index creation', is_correct: true },
                            { text: 'Disable sequential scans', is_correct: false }
                        ]
                    },
                    {
                        text: 'Which PostgreSQL data type is best suited for storing structured JSON data that needs to be queried efficiently?',
                        choices: [
                            { text: 'JSON', is_correct: false },
                            { text: 'JSONB', is_correct: true },
                            { text: 'VARCHAR', is_correct: false },
                            { text: 'TEXT', is_correct: false }
                        ]
                    },
                    {
                        text: 'What is the primary performance benefit of PostgreSQLs autovacuum process?',
                        choices: [
                            { text: 'It rebuilds all indexes automatically', is_correct: false },
                            { text: 'It compresses table data', is_correct: false },
                            { text: 'It increases shared_buffers dynamically', is_correct: false },
                            { text: 'It prevents transaction ID wraparound and removes dead tuples', is_correct: true }
                        ]
                    }
                ]
            }
        };

        function createChoiceInput(qIdx) {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-block';
            choiceDiv.style.display = 'flex';
            choiceDiv.style.gap = '0.5rem';
            choiceDiv.style.alignItems = 'center';
            choiceDiv.innerHTML = `
                <input type="text" name="choice-${qIdx}" placeholder="Choice text" required style="flex:1;">
                <label class="correct-flag" style="display:flex;align-items:center;gap:0.25rem;">
                    <input type="checkbox" name="is_correct-${qIdx}"> Correct
                </label>
                <button type="button" class="remove-choice-btn">Remove</button>
            `;
            choiceDiv.querySelector('.remove-choice-btn').onclick = () => choiceDiv.remove();
            return choiceDiv;
        }

        function updateCorrectFlagsVisibility() {
            const type = (document.getElementById('poll_type')?.value || 'trivia');
            const show = type === 'trivia';
            document.querySelectorAll('.correct-flag').forEach(el => {
                el.style.display = show ? 'flex' : 'none';
                if (!show) {
                    const chk = el.querySelector('input[type="checkbox"]');
                    if (chk) chk.checked = false;
                }
            });
        }

        function createQuestionBlock() {
            const qIdx = questionCount++;
            const qDiv = document.createElement('div');
            qDiv.className = 'question-block';
            qDiv.style.border = '1px dashed #ccc';
            qDiv.style.padding = '0.75rem';
            qDiv.style.marginBottom = '0.75rem';
            qDiv.innerHTML = `
                <label>Question</label>
                <input type="text" name="question-${qIdx}" placeholder="Type the question..." required>
                <div class="choices-container" id="choices-${qIdx}" style="margin-top:0.5rem;"></div>
                <div style="margin-top:0.5rem;display:flex;gap:0.5rem;">
                    <button type="button" class="add-choice-btn">+ Add Choice</button>
                    <button type="button" class="remove-question-btn">Remove Question</button>
                </div>
            `;

            qDiv.querySelector('.add-choice-btn').onclick = () => {
                const choicesDiv = qDiv.querySelector(`#choices-${qIdx}`);
                choicesDiv.appendChild(createChoiceInput(qIdx));
            };
            qDiv.querySelector('.remove-question-btn').onclick = () => qDiv.remove();

            // Two initial choices
            const choicesDiv = qDiv.querySelector(`#choices-${qIdx}`);
            choicesDiv.appendChild(createChoiceInput(qIdx));
            choicesDiv.appendChild(createChoiceInput(qIdx));

            return qDiv;
        }

        document.getElementById('add-question-btn').onclick = () => {
            const container = document.getElementById('questions-container');
            container.appendChild(createQuestionBlock());
            updateCorrectFlagsVisibility();
        };

        function clearQuestions() {
            document.getElementById('questions-container').innerHTML = '';
            questionCount = 0;
        }

        function buildQuestionBlockFromData(q) {
            const qDiv = document.createElement('div');
            qDiv.className = 'question-block';
            qDiv.style.border = '1px dashed #ccc';
            qDiv.style.padding = '0.75rem';
            qDiv.style.marginBottom = '0.75rem';
            const qIdx = questionCount++;
            qDiv.innerHTML = `
                <label>Question</label>
                <input type="text" name="question-${qIdx}" placeholder="Type the question..." required value="${q.text || ''}">
                <div class="choices-container" id="choices-${qIdx}" style="margin-top:0.5rem;"></div>
                <div style="margin-top:0.5rem;display:flex;gap:0.5rem;">
                    <button type="button" class="add-choice-btn">+ Add Choice</button>
                    <button type="button" class="remove-question-btn">Remove Question</button>
                </div>
            `;
            const choicesDiv = qDiv.querySelector(`#choices-${qIdx}`);
            if (Array.isArray(q.choices)) {
                q.choices.forEach(c => {
                    const choiceDiv = createChoiceInput(qIdx);
                    const textInput = choiceDiv.querySelector('input[type="text"]');
                    const chk = choiceDiv.querySelector('input[type="checkbox"]');
                    textInput.value = (typeof c === 'string') ? c : (c.text || '');
                    if (chk && typeof c === 'object' && c.is_correct) chk.checked = true;
                    choicesDiv.appendChild(choiceDiv);
                });
            } else {
                choicesDiv.appendChild(createChoiceInput(qIdx));
                choicesDiv.appendChild(createChoiceInput(qIdx));
            }
            qDiv.querySelector('.add-choice-btn').onclick = () => choicesDiv.appendChild(createChoiceInput(qIdx));
            qDiv.querySelector('.remove-question-btn').onclick = () => qDiv.remove();
            return qDiv;
        }

        document.getElementById('apply-template').onclick = () => {
            const key = document.getElementById('template-select').value;
            if (!key) return;
            const t = TEMPLATES[key];
            if (!t) return;
            // set top-level fields
            document.querySelector('input[name="title"]').value = t.title || '';
            document.querySelector('textarea[name="description"]').value = t.description || '';
            const typeSel = document.getElementById('poll_type');
            if (typeSel) typeSel.value = t.poll_type || 'trivia';
            // if template provides a slug, set it and update preview
            if (t.slug) {
                const slugInput = document.getElementById('slug');
                if (slugInput) {
                    slugInput.value = t.slug;
                    const ev = new Event('input');
                    slugInput.dispatchEvent(ev);
                }
            }
            clearQuestions();
            (t.questions || []).forEach(q => {
                const qEl = buildQuestionBlockFromData(q);
                document.getElementById('questions-container').appendChild(qEl);
            });
            updateCorrectFlagsVisibility();
        };

        document.getElementById('poll_type').addEventListener('change', updateCorrectFlagsVisibility);

        // Session minutes and slug generation
        function toLocalDatetimeValue(d) {
            const pad = (n) => String(n).padStart(2,'0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
        function applySessionMinutes() {
            const minutes = parseInt(document.getElementById('session_minutes').value, 10);
            if (!minutes || minutes <= 0) return;
            const now = new Date();
            const end = new Date(now.getTime() + minutes*60000);
            const f = document.getElementById('create-poll-form');
            f.start_time.value = toLocalDatetimeValue(now);
            f.end_time.value = toLocalDatetimeValue(end);
        }
        document.getElementById('session_minutes').addEventListener('input', applySessionMinutes);

        function randomCode(len=5) {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let s='';
            for (let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
            return s;
        }
        const genCheckbox = document.getElementById('generate_url');
        const slugInput = document.getElementById('slug');
        const slugPreview = document.getElementById('slug_preview');
        function updateSlugPreview() {
            const code = slugInput.value.trim();
            if (code) {
                slugPreview.style.display = 'block';
                slugPreview.textContent = `Join URL: ${location.origin}/${code}`;
            } else {
                slugPreview.style.display = 'none';
                slugPreview.textContent = '';
            }
        }
        genCheckbox.addEventListener('change', () => {
            if (genCheckbox.checked && !slugInput.value.trim()) {
                slugInput.value = randomCode(5);
                updateSlugPreview();
            }
        });
        slugInput.addEventListener('input', updateSlugPreview);
        </script>

        <h2>Events</h2>
        <div id="poll-list"></div>
        <template id="poll-row-template">
            <div class="poll-row" style="border:1px solid #ccc;padding:0.5rem;margin-bottom:0.5rem;">
                <div class="poll-head" style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
                    <div>
                        <strong class="poll-title"></strong>
                        <span class="poll-meta"></span>
                        <span class="status-dot"></span>
                        <span class="status-label" style="margin-left:0.35rem;font-size:0.9rem;color:#555;"></span>
                    </div>
                    <div class="row-actions">
                        <button class="toggle-actions">Toggle Actions</button>
                        <button class="toggle-json">Show details</button>
                    </div>
                </div>
                <div class="actions collapsible">
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin:0.5rem 0;">
                        <button class="activate-btn">Activate</button>
                        <button class="deactivate-btn">Deactivate</button>
                        <button class="reactivate-btn">Reactivate</button>
                        <button class="results-btn">View Results</button>
                        <button class="export-btn">Export CSV</button>
                        <button class="leaderboard-btn">Leaderboard</button>
                        <button class="delete-btn" style="background:#b00020;">Delete</button>
                    </div>
                </div>
                <pre class="json collapsible" style="max-height:150px;overflow:auto;margin:0.5rem 0;"></pre>
                <div class="row-results collapsible" style="border-top:1px solid #eee;padding-top:0.5rem;margin-top:0.5rem;">
                    <div class="row-results-body"></div>
                </div>
                <div class="row-leaderboard collapsible" style="border-top:1px solid #eee;padding-top:0.5rem;margin-top:0.5rem;">
                    <div class="row-leaderboard-body"></div>
                </div>
            </div>
        </template>

        <!-- Results & Winners Panel (fully structured) -->
        <section id="results-section" style="display:none;margin-top:1rem;border-top:1px solid #ddd;padding-top:1rem;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
                <h2 style="margin:0;">Results: <span id="results-title"></span></h2>
                <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                    <label style="display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" id="toggle-details"> Show details
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem;">
                        <input type="checkbox" id="toggle-correct"> Show correct answers
                    </label>
                    <button id="export-csv" type="button">Export CSV</button>
                    <button id="view-leaderboard" type="button">Leaderboard</button>
                    <button id="close-results" type="button">Close</button>
                </div>
            </div>

            <div id="winner-main" style="margin-top:0.5rem;padding:0.5rem 0;font-weight:600;color:#2e7d32;"></div>

            <!-- Charts (hidden by default until details enabled) -->
            <div id="results-charts" style="display:none;margin-top:0.75rem;gap:1rem;"></div>

            <div id="leaderboard-panel" style="display:none;margin-top:1rem;border:1px solid #eee;padding:0.75rem;border-radius:6px;">
                <h3 style="margin:0 0 0.5rem 0;">Leaderboard (Trivia)</h3>
                <ol id="leaderboard-list" style="margin:0;padding-left:1.25rem;"></ol>
            </div>

            <div id="winners-panel" style="display:none;margin-top:1rem;border:1px solid #eee;padding:0.75rem;border-radius:6px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0;">Winners</h3>
                    <div style="display:flex;gap:0.5rem;">
                        <button id="refresh-winners" type="button">Refresh</button>
                        <button id="pick-winner" type="button">Pick Random Winner</button>
                    </div>
                </div>
                <div id="picked-winner" style="margin-top:0.5rem;color:#2e7d32;font-weight:600;"></div>
                <ul id="winners-list" style="margin-top:0.5rem;display:none;"></ul>
            </div>

            <div id="nonwinners-panel" style="display:none;margin-top:1rem;border:1px solid #eee;padding:0.75rem;border-radius:6px;">
                <h3 style="margin:0;">Participants who didn't answer all correctly</h3>
                <ul id="nonwinners-list" style="margin-top:0.5rem;"></ul>
            </div>
        </section>
        </section>
    </section>
</div>

<script>
let token = null;
// Ensure logout is always wired (was previously inside another function causing issues)
(function bindLogout(){
    const btn = document.getElementById('logout-btn');
    if (btn) {
        btn.addEventListener('click', () => {
            try { localStorage.removeItem('adminToken'); } catch (_) {}
            token = null;
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
        });
    }
})();
let currentPollId = null;
let charts = []; // { chart: Chart, isCorrects: boolean[] }

// Auto-restore admin session on refresh
(function restoreAdmin(){
    try {
        const saved = localStorage.getItem('adminToken');
        if (saved) {
            token = saved;
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            loadPolls();
        }
    } catch (_) {}
})();

// Helper
async function api(path, opts = {}) {
    const headers = opts.headers ? { ...opts.headers } : {};
    if (token) headers['Authorization'] = `Bearer ${token}`;
    if (!headers['Content-Type'] && opts.body && typeof opts.body === 'string') {
        headers['Content-Type'] = 'application/json';
    }
    const resp = await fetch(path, { ...opts, headers });
    if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(`Error ${resp.status}: ${txt}`);
    }
    return await resp.json();
}

// Login
document.getElementById('login-form').onsubmit = async (e) => {
    e.preventDefault();
    const f = e.target;
    try {
        const payload = { username: f.username.value, password: f.password.value };
        const res = await api('/admin/login', {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'application/json' }
        });
        token = res.access_token;
        try { localStorage.setItem('adminToken', token); } catch (_) {}
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'block';
        loadPolls();
    } catch (err) {
        alert('Login failed: ' + err.message);
    }
};

// Create poll
document.getElementById('create-poll-form').onsubmit = async (e) => {
    e.preventDefault();
    const f = e.target;

    // Gather questions and choices from dynamic UI
    const questions = [];
    const qBlocks = document.querySelectorAll('.question-block');
    qBlocks.forEach(qb => {
        const qText = qb.querySelector(`input[name^="question-"]`).value.trim();
        if (!qText) return; // skip empty
        const choices = [];
        const choiceBlocks = qb.querySelectorAll('.choice-block');
        choiceBlocks.forEach(block => {
            const textInput = block.querySelector('input[type="text"]');
            const checkInput = block.querySelector('input[type="checkbox"]');
            const cText = (textInput?.value || '').trim();
            const isCorrect = !!(checkInput && checkInput.checked);
            if (cText) choices.push({ text: cText, is_correct: isCorrect });
        });
        if (choices.length === 0) return; // need at least one choice
        questions.push({ text: qText, choices });
    });

    const payload = {
        title: f.title.value,
        description: f.description.value,
        poll_type: (document.getElementById('poll_type')?.value || 'trivia'),
        start_time: f.start_time.value ? new Date(f.start_time.value).toISOString() : null,
        end_time: f.end_time.value ? new Date(f.end_time.value).toISOString() : null,
        slug: (document.getElementById('slug')?.value || '').trim() || undefined,
        questions
    };
    try {
        await api('/admin/polls', { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
        alert('Event created');
        f.reset();
        document.getElementById('questions-container').innerHTML = '';
        questionCount = 0;
        loadPolls();
    } catch (err) {
        alert('Failed to create event: ' + err.message);
    }
};

// Load polls
async function loadPolls() {
    const listDiv = document.getElementById('poll-list');
    listDiv.innerHTML = 'Loading...';
    try {
        const polls = await api('/admin/polls');
        if (!polls || polls.length === 0) {
            listDiv.innerHTML = '<p>No Events yet</p>';
            return;
        }
        listDiv.innerHTML = '';
        const tpl = document.getElementById('poll-row-template');
        polls.forEach(p => {
            const node = tpl.content.cloneNode(true);
            node.querySelector('.poll-title').textContent = `${p.title} (ID: ${p.id})`;
            node.querySelector('.poll-meta').innerHTML = `Type: ${p.poll_type || 'trivia'} | Join Code: <code>${p.slug || '(none)'}</code>`;
            const dot = node.querySelector('.status-dot');
            const stateClass = p.expired ? 'expired' : (p.is_active ? 'active' : 'inactive');
            dot.className = `status-dot ${stateClass}`;
            dot.title = p.expired ? 'Expired' : (p.is_active ? 'Active' : 'Inactive');
            const labelEl = node.querySelector('.status-label');
            if (labelEl) labelEl.textContent = p.expired ? 'Expired' : (p.is_active ? 'Active' : 'Inactive');
            // actions
            const row = node.querySelector('.poll-row');
            const actions = node.querySelector('.actions');
            const json = node.querySelector('.json');
            const toggleActions = node.querySelector('.toggle-actions');
            const toggleJson = node.querySelector('.toggle-json');
            toggleActions.onclick = () => actions.classList.toggle('open');
            toggleJson.onclick = () => {
                json.classList.toggle('open');
                toggleJson.textContent = json.classList.contains('open') ? 'Hide details' : 'Show details';
            };
            json.textContent = JSON.stringify(p, null, 2);
            // buttons wired per row
            row.querySelector('.activate-btn').onclick = async () => { await api(`/admin/polls/${p.id}/activate`, { method:'POST' }); loadPolls(); };
            row.querySelector('.deactivate-btn').onclick = async () => { await api(`/admin/polls/${p.id}/deactivate`, { method:'POST' }); loadPolls(); };
            row.querySelector('.reactivate-btn').onclick = async () => {
                const input = prompt('Re-activate for how many minutes?', '2');
                if (input === null) return;
                const minutes = parseInt(input, 10);
                if (!minutes || minutes <= 0) {
                    alert('Please enter a valid number of minutes.');
                    return;
                }
                try {
                    await api(`/admin/polls/${p.id}/reactivate`, {
                        method: 'POST',
                        body: JSON.stringify({ minutes }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    loadPolls();
                } catch (err) {
                    alert('Failed to reactivate: ' + err.message);
                }
            };
            row.querySelector('.results-btn').onclick = async () => {
                const rowResults = row.querySelector('.row-results');
                const body = row.querySelector('.row-results-body');
                // Toggle
                if (rowResults.classList.contains('open')) {
                    rowResults.classList.remove('open');
                    body.innerHTML = '';
                    return;
                }
                body.innerHTML = 'Loading results...';
                try {
                    const res = await api(`/admin/polls/${p.id}/results`);
                    body.innerHTML = '';
                    const isTrivia = (res.poll_type || 'trivia') === 'trivia';

                    const chartsWrap = document.createElement('div');
                    chartsWrap.style.display = 'grid';
                    chartsWrap.style.gap = '0.5rem';
                    body.appendChild(chartsWrap);

                    res.results.forEach((q, idx) => {
                        const card = document.createElement('div');
                        card.style.border = '1px solid #eee';
                        card.style.padding = '0.5rem';
                        card.style.borderRadius = '6px';
                        card.innerHTML = `<div style="margin-bottom:0.25rem;"><strong>Q${idx + 1}:</strong> ${q.question_text}</div>`;
                        const canvas = document.createElement('canvas');
                        canvas.height = 140;
                        card.appendChild(canvas);
                        chartsWrap.appendChild(card);

                        let labels, data, bg, border;
                        const choiceLabels = q.choices.map(c => c.choice_text);
                        const choiceVotes = q.choices.map(c => c.votes);
                        const totalVotes = choiceVotes.reduce((a,b)=>a+b,0) || 1;
                        if (isTrivia) {
                            const correctVotes = q.choices.filter(c => !!c.is_correct).reduce((a,c)=>a+c.votes,0);
                            const incorrectVotes = totalVotes - correctVotes;
                            labels = ['Correct','Incorrect'];
                            data = [correctVotes, incorrectVotes];
                            bg = ['#2e7d32','#d0d0d0'];
                            border = ['#2e7d32','#8a8a8a'];
                        } else {
                            labels = choiceLabels;
                            data = choiceVotes;
                            bg = ['#4C78A8','#F58518','#54A24B','#E45756','#72B7B2','#EECA3B','#B279A2','#FF9DA7'];
                            border = bg;
                        }
                        new Chart(canvas.getContext('2d'), {
                            type: 'doughnut',
                            data: { labels, datasets: [{ data, backgroundColor: bg, borderColor: border, borderWidth: 1 }] },
                            options: { responsive:true, maintainAspectRatio:false, cutout:'55%', plugins:{ legend:{ position:'bottom' } } }
                        });
                    });

                    rowResults.classList.add('open');
                } catch (err) {
                    body.innerHTML = `<p>Error loading results: ${err.message}</p>`;
                    rowResults.classList.add('open');
                }
            };
            row.querySelector('.export-btn').onclick = async () => {
                try {
                    const resp = await fetch(`/admin/polls/${p.id}/export.csv`, { headers: token ? { 'Authorization': `Bearer ${token}` } : {} });
                    if (!resp.ok) { const t = await resp.text(); throw new Error(`Error ${resp.status}: ${t}`); }
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `event_${p.id}_summary.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                } catch (err) {
                    alert('Failed to export CSV: ' + err.message);
                }
            };
            const lbBtn = row.querySelector('.leaderboard-btn');
            const lbPanel = row.querySelector('.row-leaderboard');
            const lbBody = row.querySelector('.row-leaderboard-body');
            if ((p.poll_type || 'trivia') !== 'trivia') {
                lbBtn.style.display = 'none';
            } else {
                lbBtn.onclick = async () => {
                    // Toggle panel
                    if (lbPanel.classList.contains('open')) {
                        lbPanel.classList.remove('open');
                        lbBody.innerHTML = '';
                        return;
                    }
                    // Open and load leaderboard + winners
                    lbPanel.classList.add('open');
                    lbBody.innerHTML = 'Loading leaderboard...';
                    try {
                        const [lbRes, winRes] = await Promise.all([
                            api(`/admin/polls/${p.id}/leaderboard`),
                            api(`/admin/polls/${p.id}/winners`)
                        ]);
                        const wrapper = document.createElement('div');
                        // Winners summary + per-row pick button
                        const winners = (winRes && Array.isArray(winRes.winners)) ? winRes.winners : [];
                        const winDiv = document.createElement('div');
                        winDiv.style.display = 'flex';
                        winDiv.style.alignItems = 'center';
                        winDiv.style.justifyContent = 'space-between';
                        winDiv.style.gap = '0.5rem';
                        winDiv.style.marginBottom = '0.5rem';
                        const winLabel = document.createElement('div');
                        winLabel.innerHTML = `<strong>Winners:</strong> ${winners.length > 0 ? winners.map(w => `${w.name || 'Anonymous'}${w.company ? ' ('+w.company+')' : ''}`).join(', ') : '(none yet)'}`;
                        winDiv.appendChild(winLabel);
                        const pickWrap = document.createElement('div');
                        const pickMsg = document.createElement('span');
                        pickMsg.style.marginLeft = '0.5rem';
                        if (winners.length > 1) {
                            const pickBtn = document.createElement('button');
                            pickBtn.textContent = 'Pick Random Winner';
                            pickBtn.className = 'mini-btn';
                            pickBtn.onclick = async () => {
                                pickBtn.disabled = true;
                                pickBtn.textContent = 'Picking...';
                                try {
                                    const r = await api(`/admin/polls/${p.id}/pick-winner`, { method: 'POST' });
                                    const w = r.winner;
                                    pickMsg.textContent = ` Selected: ${w.name || 'Anonymous'}${w.company ? ' (' + w.company + ')' : ''}`;
                                } catch (err) {
                                    pickMsg.textContent = ` Failed: ${err.message}`;
                                } finally {
                                    pickBtn.disabled = false;
                                    pickBtn.textContent = 'Pick Random Winner';
                                }
                            };
                            pickWrap.appendChild(pickBtn);
                            pickWrap.appendChild(pickMsg);
                        }
                        winDiv.appendChild(pickWrap);
                        wrapper.appendChild(winDiv);

                        // Leaderboard list
                        const h = document.createElement('div');
                        h.style.margin = '0.25rem 0';
                        h.innerHTML = '<strong>Leaderboard</strong>';
                        wrapper.appendChild(h);
                        const ol = document.createElement('ol');
                        ol.style.margin = '0';
                        ol.style.paddingLeft = '1.25rem';
                        (lbRes.rows || []).forEach(r => {
                            const li = document.createElement('li');
                            li.textContent = `${r.name || 'Anonymous'}${r.company ? ' (' + r.company + ')' : ''} - ${r.correct_count}/${r.total_questions} (${r.percent}%)`;
                            ol.appendChild(li);
                        });
                        if (!lbRes.rows || lbRes.rows.length === 0) {
                            const li = document.createElement('li');
                            li.textContent = 'No submissions yet.';
                            ol.appendChild(li);
                        }
                        wrapper.appendChild(ol);

                        lbBody.innerHTML = '';
                        lbBody.appendChild(wrapper);
                    } catch (err) {
                        lbBody.innerHTML = `<p>Error loading leaderboard: ${err.message}</p>`;
                    }
                };
            }
            row.querySelector('.delete-btn').onclick = async () => {
                if (!confirm('Delete this event and all associated data?')) return;
                try {
                    await api(`/admin/polls/${p.id}`, { method:'DELETE' });
                    // Safely hide results panel if it exists
                    destroyCharts();
                    const rs = document.getElementById('results-section');
                    if (rs && rs.style) {
                        rs.style.display = 'none';
                    }
                    // Refresh list
                    loadPolls();
                } catch (err) {
                    alert('Failed to delete poll: ' + err.message);
                }
            };
            listDiv.appendChild(node);
        });
    } catch (err) {
        listDiv.innerHTML = `<p>Error loading events: ${err.message}</p>`;
    }
}

function computeColors(isCorrects, highlight) {
    // Pleasant qualitative palette
    const palette = [
        '#4C78A8','#F58518','#54A24B','#E45756','#72B7B2','#EECA3B','#B279A2','#FF9DA7','#9D755D','#BAB0AC'
    ];
    const correctColor = '#2e7d32';
    const wrongMuted = '#d0d0d0';
    const borderMuted = '#8a8a8a';
    const bg = [];
    const border = [];
    for (let i = 0; i < isCorrects.length; i++) {
        if (!highlight) {
            const color = palette[i % palette.length];
            bg.push(color);
            border.push(color);
        } else {
            if (isCorrects[i]) {
                bg.push(correctColor);
                border.push(correctColor);
            } else {
                bg.push(wrongMuted);
                border.push(borderMuted);
            }
        }
    }
    return { bg, border };
}

function destroyCharts() {
    charts.forEach(entry => entry.chart.destroy());
    charts = [];
}

async function openResults(pollId) {
    currentPollId = pollId;
    const res = await api(`/admin/polls/${pollId}/results`);
    const isTrivia = (res.poll_type || 'trivia') === 'trivia';
    document.getElementById('results-title').textContent = res.title || `Poll ${pollId}`;

    // Toggle trivia-specific UI
    const toggleCorrectInput = document.getElementById('toggle-correct');
    const toggleCorrectLabel = toggleCorrectInput?.parentElement;
    if (toggleCorrectLabel) toggleCorrectLabel.style.display = isTrivia ? 'flex' : 'none';
    document.getElementById('winners-panel').style.display = isTrivia ? 'block' : 'none';
    document.getElementById('nonwinners-panel').style.display = isTrivia ? 'block' : 'none';
    document.getElementById('leaderboard-panel').style.display = isTrivia ? 'block' : 'none';

    // Build charts (hidden by default until details enabled)
    destroyCharts();
    const chartsContainer = document.getElementById('results-charts');
    chartsContainer.innerHTML = '';

    res.results.forEach((q, idx) => {
        const card = document.createElement('div');
        card.style.border = '1px solid #eee';
        card.style.padding = '0.75rem';
        card.style.borderRadius = '6px';
        card.innerHTML = `<div style="margin-bottom:0.5rem;"><strong>Q${idx + 1}:</strong> ${q.question_text}</div>`;
        const canvas = document.createElement('canvas');
        canvas.height = 160;
        card.appendChild(canvas);
        chartsContainer.appendChild(card);

        let labels, data, bg, border, isCorrects;
        const highlightCorrect = document.getElementById('toggle-correct').checked;
        const choiceLabels = q.choices.map(c => c.choice_text);
        const choiceVotes = q.choices.map(c => c.votes);
        const totalVotes = choiceVotes.reduce((a,b)=>a+b,0) || 1;

        if (isTrivia) {
            const correctVotes = q.choices.filter(c => !!c.is_correct).reduce((a,c)=>a+c.votes,0);
            const incorrectVotes = totalVotes - correctVotes;
            labels = ['Correct', 'Incorrect'];
            data = [correctVotes, incorrectVotes];
            bg = ['#2e7d32', '#d0d0d0'];
            border = ['#2e7d32', '#8a8a8a'];
            isCorrects = [true, false];
        } else {
            labels = choiceLabels;
            data = choiceVotes;
            isCorrects = q.choices.map(c => !!c.is_correct);
            const colors = computeColors(isCorrects, highlightCorrect);
            bg = colors.bg;
            border = colors.border;
        }

        const chart = new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    label: 'Votes',
                    data,
                    backgroundColor: bg,
                    borderColor: border,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const value = ctx.parsed;
                                const total = data.reduce((a,b)=>a+b,0) || 1;
                                const pct = ((value / total) * 100).toFixed(0);
                                return `${ctx.label}: ${value} (${pct}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true
                }
            }
        });

// Export CSV (results panel)
const exportBtn = document.getElementById('export-csv');
if (exportBtn) exportBtn.addEventListener('click', async () => {
    if (!currentPollId) return;
    try {
        const resp = await fetch(`/admin/polls/${currentPollId}/export.csv`, { headers: token ? { 'Authorization': `Bearer ${token}` } : {} });
        if (!resp.ok) { const t = await resp.text(); throw new Error(`Error ${resp.status}: ${t}`); }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `event_${currentPollId}_summary.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    } catch (err) {
        alert('Failed to export CSV: ' + err.message);
    }
});

// Leaderboard
const lbBtn = document.getElementById('view-leaderboard');
if (lbBtn) lbBtn.addEventListener('click', async () => {
    if (!currentPollId) return;
    try {
        const res = await api(`/admin/polls/${currentPollId}/leaderboard`);
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '';
        (res.rows || []).forEach(r => {
            const li = document.createElement('li');
            li.textContent = `${r.name || 'Anonymous'}${r.company ? ' (' + r.company + ')' : ''} - ${r.correct_count}/${r.total_questions} (${r.percent}%)`;
            list.appendChild(li);
        });
    } catch (err) {
        alert('Failed to load leaderboard: ' + err.message);
    }
});
        charts.push({ chart, isCorrects });
    });

    document.getElementById('results-section').style.display = 'block';

    await loadWinners();

    // Respect details toggle on initial open
    const details = document.getElementById('toggle-details').checked;
    chartsContainer.style.display = details ? 'grid' : 'none';
    document.getElementById('winners-list').style.display = details ? 'block' : 'none';
    document.getElementById('nonwinners-panel').style.display = details ? 'block' : 'none';
}

function updateChartColors() {
    const highlight = document.getElementById('toggle-correct').checked;
    charts.forEach(({ chart, isCorrects }) => {
        const colors = computeColors(isCorrects, highlight);
        chart.data.datasets[0].backgroundColor = colors.bg;
        chart.data.datasets[0].borderColor = colors.border;
        chart.update();
    });
}

document.getElementById('toggle-correct').addEventListener('change', updateChartColors);

document.getElementById('toggle-details').addEventListener('change', () => {
    const chartsContainer = document.getElementById('results-charts');
    const show = document.getElementById('toggle-details').checked;
    chartsContainer.style.display = show ? 'grid' : 'none';
    document.getElementById('winners-list').style.display = show ? 'block' : 'none';
    document.getElementById('nonwinners-panel').style.display = show ? 'block' : 'none';
});

document.getElementById('close-results').addEventListener('click', () => {
    destroyCharts();
    document.getElementById('results-section').style.display = 'none';
});

async function loadWinners() {
    const listEl = document.getElementById('winners-list');
    const pickedEl = document.getElementById('picked-winner');
    const winnerMain = document.getElementById('winner-main');
    const nonList = document.getElementById('nonwinners-list');
    pickedEl.textContent = '';
    winnerMain.textContent = '';
    listEl.innerHTML = 'Loading...';
    nonList.innerHTML = '';
    try {
        const res = await api(`/admin/polls/${currentPollId}/winners`);
        const winners = res.winners || [];
        const participants = res.participants || [];
        const total = res.total_questions || 0;

        // Populate winners simple view
        if (winners.length > 0) {
            const first = winners[0];
            winnerMain.textContent = `Winner: ${first.name || 'Anonymous'}${first.company ? ' (' + first.company + ')' : ''}`;
        } else {
            winnerMain.textContent = 'Winner: (none yet)';
        }

        // Detailed lists (shown when details enabled)
        listEl.innerHTML = '';
        winners.forEach(w => {
            const li = document.createElement('li');
            li.textContent = `${w.name || 'Anonymous'}${w.company ? ' (' + w.company + ')' : ''}`;
            listEl.appendChild(li);
        });
        if (winners.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'No winners yet (no participant answered all questions correctly).';
            listEl.appendChild(li);
        }

        // Non-winners summary
        const nonwinners = participants.filter(p => !(p.is_winner));
        if (nonwinners.length > 0) {
            nonwinners.forEach(n => {
                const li = document.createElement('li');
                li.textContent = `${n.name || 'Anonymous'}${n.company ? ' (' + n.company + ')' : ''}  ${n.correct_count}/${n.total_questions} correct`;
                nonList.appendChild(li);
            });
        } else {
            nonList.innerHTML = '<li>Everyone answered all questions correctly.</li>';
        }
    } catch (err) {
        listEl.innerHTML = `<li>Error: ${err.message}</li>`;
    }
}

document.getElementById('refresh-winners').addEventListener('click', loadWinners);

document.getElementById('pick-winner').addEventListener('click', async () => {
    const pickedEl = document.getElementById('picked-winner');
    const winnerMain = document.getElementById('winner-main');
    pickedEl.textContent = '';
    try {
        const res = await api(`/admin/polls/${currentPollId}/pick-winner`, { method: 'POST' });
        const w = res.winner;
        const label = `${w.name || 'Anonymous'}${w.company ? ' (' + w.company + ')' : ''}`;
        pickedEl.textContent = `Selected: ${label}`;
        winnerMain.textContent = `Winner: ${label}`;
        await loadWinners();
    } catch (err) {
        pickedEl.textContent = `No winner selected: ${err.message}`;
    }
});
</script>
</body>
</html>